- name: Create user
  user:
    name: "{{ foreman_user }}"
    createhome: no

- name: Create tornado log files directory
  file:
    path: /var/log/tornado/
    state: directory
    owner: "{{ foreman_user }}"

- name: Copy Nginx configuration
  template:
    src: nginx.conf.j2
    dest: "{{nginx_dir}}/sites-available/default"
    owner: root
    group: root
    mode: 0644
  tags: update

- name: Check if managed by Supervisor
  supervisorctl: name=archiverforeman state=present
  register: foreman_is_managed
  ignore_errors: true

- name: Add to Supervisor
  template:
    src: archiverforeman.conf.j2
    dest: /etc/supervisor/conf.d/archiverforeman.conf
    owner: root
    group: root
    mode: 0644
  when: 'foreman_is_managed is not defined or foreman_is_managed|failed'
  tags: update

- name: Reload Supervisor
  supervisorctl:
    name: archiverforeman
    state: present

- name: Start foreman
  supervisorctl:
    name: archiverforeman
    state: started
  when: 'foreman_is_managed|failed'
  register: foreman_started
  ignore_errors: true

- name: Restart foreman
  supervisorctl:
    name: archiverforeman
    state: restarted
  tags: update
  when: 'foreman_is_managed is not defined or foreman_started|skipped'

- name: Restart Nginx
  service:
    name: nginx
    state: restarted
  tags: update
