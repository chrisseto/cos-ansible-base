---

- name: Make sure envs directory exists
  file:
    path: "{{osf_virtualenvs_dir}}"
    state: directory
    group: osf
    owner: www-data
    mode: 0755

- name: Create virtualenv
  command: "virtualenv {{osf_virtualenvs_dir}}osf"
  args:
    creates: "{{osf_virtualenvs_dir}}osf/bin/python"

- name: Make sure invoke is installed
  pip:
    name: invoke
    virtualenv: "{{osf_virtualenv}}"

- name: Make sure osf group and www-data own the virtualenv
  file:
    path: "{{osf_virtualenv}}"
    state: directory
    recurse: yes
    mode: 0775
    group: osf
    owner: www-data

- name: "Make sure apps folder exists and is owned by the osf group"
  file:
    path: "{{ osf_apps_dir }}"
    state: directory
    group: osf
    recurse: yes
    mode: 0777
    owner: www-data
  tags:
    - update

- name: Pull the latest changes from Github
  git:
    repo: "git@github.com:CenterForOpenScience/osf.git"
    dest: "{{ osf_repo_dir }}"
    version: "{{ osf_repo_branch }}"
    update: yes
  sudo: False
  tags:
    - update

- name: Copy local-dist.py -> local.py
  command: "cp {{osf_repo_dir}}website/settings/local-dist.py {{osf_repo_dir}}website/settings/local.py"
  args:
    creates: "{{osf_repo_dir}}website/settings/local.py"

# update dependencies
- name: Update bower components
  command: bower install
  args:
    chdir: /opt/apps/osf/
  sudo: no
  tags:
    - update

- name: Make sure requirements are up to date
  pip:
    requirements: "{{ osf_repo_dir }}requirements.txt"
    virtualenv: "{{osf_virtualenv}}"
  tags:
    - update

- name: Make sure mfr requirements are up to date
  pip:
    requirements: "{{osf_repo_dir}}mfr/requirements.txt"
    virtualenv: "{{osf_virtualenv}}"
  tags:
    - update
# TODO: addon requirements

- name: Install addon requirements
  command: "{{osf_virtualenv}}bin/invoke addon_requirements"
  args:
    chdir: "{{osf_repo_dir}}"

- name: Make sure the repo is owned by the osf group
  file:
    path: "{{osf_repo_dir}}"
    state: directory
    group: osf
    recurse: yes
    mode: 0775
    owner: www-data

- name: Make sure the git directory is owned by the osf group
  file:
    path: "/opt/apps/osf/.git"
    state: directory
    group: osf
    recurse: yes
    mode: 0775

- name: Copy supervisor config for uwsgi
  template:
    src: uwsgi.conf.j2
    dest: /etc/supervisor/conf.d/uwsgi.conf
  tags:
    - update

- name: Copy nginx config
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/sites-available/osf.conf
  tags:
    - update

- name: Enable osf in nginx
  file:
    src: /etc/nginx/sites-available/osf.conf
    dest: /etc/nginx/sites-enabled/osf.conf
    state: link
  tags:
    - update

- name: Copy uwsgi config to /etc/uwsgi/apps-available
  template:
    src: uwsgi.ini.j2
    dest: "/etc/uwsgi/apps-available/osf.ini"
    owner: www-data
    group: www-data
    mode: 0644
  tags:
    - update

- name: Link uwsgi config to apps-enabled
  file:
    src: /etc/uwsgi/apps-available/osf.ini
    dest: /etc/uwsgi/apps-enabled/osf.ini
    state: link
  tags:
    update

- name: Restart uwsgi
  supervisorctl:
    name: uwsgi
    state: started
  tags:
    - update

- name: Restart nginx
  service:
    name: nginx
    state: started
  tags:
    - update
